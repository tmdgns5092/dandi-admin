<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>단디 | 관리자</title>
  <link rel="shortcut icon" href="/dist/img/AdminLTELogo.png" type="image/x-icon">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="./plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="./plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="./plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="./plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="./dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="./plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="./plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="./plugins/summernote/summernote-bs4.min.css">

  <script src="./dist/js/includeHTML.js"></script>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">

    <!-- Navbar -->
    <div include-html="./include/navbar.html"></div>

    <!-- Main Sidebar Container -->
    <div include-html="./include/sidebar.html"></div>


    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <!-- <ion-icon name="cash-outline"></ion-icon>
              <h1 class="m-0">포럼</h1> -->
            </div><!-- /.col -->
          </div><!-- /.row -->
        </div><!-- /.container-fluid -->
      </div>
      <!-- /.content-header -->

      <!-- Main content -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-12">
              <div class="card card-primary">
                <div class="card-header">
                  <h3 class="card-title">포럼 소식 정보</h3>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                  <h3>제목 : <span name="title"></span></h3>

                  <!-- notice image & youtube -->
                  <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators"></ol>
                    <div class="carousel-inner"></div>
                    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="sr-only">Next</span>
                    </a>
                  </div>
                  <div name="comment"></div>
                </div>
                <!-- /.card-body -->
                <div class="card-footer">
                  <a href="javascript:void(0);" class="btn btn-primary" data-toggle="modal" data-target="#modal-notice"><b>수정</b></a>
                  <button type="button" class="btn btn-primary" onclick="noticeDestroy()">삭제</button>
                </div>
                <!-- /.card-footer -->
              </div>
            </div>

          </div>
          <!-- /.col-md-6 -->
        </div>
        <!-- /.row -->
      </div>
      <!-- /.container-fluid -->
      <!-- 소식 수정 모달  -->
      <div class="modal fade" id="modal-notice">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">소식 수정</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">×</span>
              </button>
            </div>
            <div class="modal-body">

              <!-- <form id="FILE_FORM" method="put" enctype="multipart/form-data" action="http://210.114.1.125:3000/notice/"> -->
              <form id="FILE_FORM" method="put" enctype="multipart/form-data" action="http://210.114.1.125:3000/notice/">
                <label for="exampleInputFile">이미지를 선택해 주세요</label>
                <div class="input-group">
                  <div class="custom-file">
                    <input type="file" class="custom-file-input" id="img" name="img" accept="image/*" multiple>
                    <label class="custom-file-label" for="img" id="fileName">이미지 파일</label>
                  </div>
                </div>
              </form>
                <label for="exampleInputFile">* 제목</label>
                <div class="input-group">
                  <input type="text" class="form-control datepicker-input" id="mf_title" name="mf_title"/>
                </div>

                <label for="exampleInputFile">* 본문</label>
                <div class="input-group">
                  <textarea class="form-control" id="mf_comment" rows="3"></textarea>
                </div>

                <label for="exampleInputFile">유튜브 링크</label>
                <div class="input-group" name="ytLinkBox" id="ytLinkBox">
                  <input type="text" class="form-control datepicker-input" name="yt_link"/>
                  <a href="javascript:void(0);" class="btn btn-primary" onclick="ytLinkAdd()"><b>추가</b></a>
                </div>
              <!-- </form> -->
            </div>
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
              <button type="button" class="btn btn-primary toastsDefaultSuccess" onclick="noticeUpdate()">확인</button>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>


    </div>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <div include-html="./include/footer.html"></div>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
<!-- ./wrapper -->

<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
$.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<!-- <script src="plugins/chart.js/Chart.min.js"></script> -->
<!-- Sparkline -->
<!-- <script src="plugins/sparklines/sparkline.js"></script> -->
<!-- JQVMap -->
<!-- <script src="plugins/jqvmap/jquery.vmap.min.js"></script> -->
<!-- <script src="plugins/jqvmap/maps/jquery.vmap.usa.js"></script> -->
<!-- jQuery Knob Chart -->
<!-- <script src="plugins/jquery-knob/jquery.knob.min.js"></script> -->
<!-- daterangepicker -->
<script src="plugins/moment/moment.min.js"></script>
<script src="plugins/daterangepicker/daterangepicker.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>
<!-- AdminLTE for demo purposes -->
<!-- <script src="dist/js/demo.js"></script> -->
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<!-- <script src="dist/js/pages/dashboard.js"></script> -->
<!-- Icons -->
<script src="https://unpkg.com/ionicons@5.2.3/dist/ionicons.js"></script>
<!-- jQuery Core 3.5.1 -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<!-- ajaxForm -->
<script src="https://malsup.github.com/jquery.form.js"></script>
<!-- tooltip -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
<!-- User Sciprt -->
<script>includeHTML();</script>
<script>
var _value   = new Array();
$(document).ready(function() {
  if(!$.cookie('loginCheck') || $.cookie('loginCheck') != "check")
    window.location.href = `index.html`;


  $("#carouselExampleControls").on('slid.bs.carousel', function () {
    alert('Finished sliding');
  });


  var url      = unescape(location.href);
  var pm       = url.split('?');
  var params   = pm[1].split('&');
  params.forEach((param, index) => {
    var data = param.split('=');
    var id = data[0];
    var val = data[1];
    var tmp = { id: val };
    _value.push(tmp)
  });

  $.ajax(
    {
      type:     "get",
      // url:      "http://210.114.1.125:3000/notice/",
      url:      "http://210.114.1.125:3000/notice/",
      data:     { notice_id: _value[0].id, },
      dataType: "json",
      success: data => {
        console.log(data)
        // title & comment
        $('span[name=title]').text(data.notice.title)
        $('#mf_title').val(data.notice.title)
        $('div[name=comment]').text(data.notice.comment)
        $('#mf_comment').val(data.notice.comment)
        // notice image
        if(data.img.length > 0){
          data.img.forEach((img, index) => {
            if(index == 0){
              $('.carousel-indicators').append(`<li data-target="#carouselExampleIndicators" data-slide-to="${index}" class="active"></li>`)
              $('.carousel-inner').append(`
                <div class="carousel-item active">
                  <img class="img-fluid mx-auto d-block" src="http://210.114.1.125:3000/notice/img/${img.name}" alt="${img.name}">
                </div>
                `)
            } else {
              $('.carousel-indicators').append(`<li data-target="#carouselExampleIndicators" data-slide-to="${index}"></li>`)
              $('.carousel-inner').append(`
                <div class="carousel-item">
                  <img class="img-fluid mx-auto d-block" src="http://210.114.1.125:3000/notice/img/${img.name}" alt="${img.name}">
                </div>
                `)
            }
          });
        }

        let size = $('.carousel-indicators').children().length;
        // youtube link
        data.yt.forEach((yt, index) => {
          if(yt.link){
            if(index == 0 && size == 0) {
              $('.carousel-indicators').append(`<li data-target="#carouselExampleIndicators" data-slide-to="${index}" class="active"></li>`)
              $('.carousel-inner').append(`
                <div class="carousel-item active">
                  <div class="embed-responsive embed-responsive-16by9">
                    <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/${yt.link}?rel=0" allowfullscreen></iframe>
                  </div>
                </div>
                `)
            } else {
              $('.carousel-indicators').append(`<li data-target="#carouselExampleIndicators" data-slide-to="${size + index}" class=""></li>`)
              $('.carousel-inner').append(`
                <div class="carousel-item">
                  <div class="embed-responsive embed-responsive-16by9">
                    <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/${yt.link}?rel=0" allowfullscreen></iframe>
                  </div>
                </div>
                `)
            }
            if(index == 0) {
              $('input[name=yt_link]').val(`https://www.youtube.com/embed/${yt.link}`)
            }
            else {
              $('#ytLinkBox').after(`
                <div class="input-group" name="ytLinkBox">
                  <input type="text" class="form-control datepicker-input" name="yt_link" value="https://www.youtube.com/embed/${yt.link}"/>
                  <a href="javascript:void(0);" class="btn btn-primary" onclick="removeYtBox(this)"><b>삭제</b></a>
                </div>
                `)
            }
          }
        });
      },
      error: error =>  { console.log(error) }
    });
});

function noticeUpdate(){
  console.log("notice add")
  let img, title, comment, yt_links = new Array();

  $('input[name=yt_link]').each((index, yt_link) => {
    let link = $(yt_link).val()


    if(link.indexOf('?') > 0)
      link = link.substring(0, link.indexOf('?'))

    let yt_tmp = link.split("/");
    link = yt_tmp[yt_tmp.length -1];

    yt_links.push(link);
  });

  title     = $('#mf_title').val();
  comment   = $('#mf_comment').val();
  img       = $('#img').val();

  if(!title){
    alert('제목을 입력해주세요');
    $('#title').focus();
    return false;
  }
  if(!comment){
    alert('본문을 입력해 주세요.')
    $('#comment').focus();
    return false;
  }

  var form = $('#FILE_FORM')[0];
  var formData = new FormData(form);
  // formData.append("img", $("#img")[0].files);
  formData.append("notice_id", _value[0].id);
  formData.append("title", title);
  formData.append("comment", comment);
  formData.append("yt_links", yt_links.join('|'));

  $.ajax(
    {
      type:     "put",
      url:      "http://210.114.1.125:3000/notice/",
      data:     formData,
      processData: false,
      contentType: false,
      dataType: "json",
      async: false,
      success: data => {
        console.log(data)
        window.location.href = `noticeInfo.html?id=${_value[0].id}`;
      },
      error: error =>  { console.log(error) }
    });
}

function ytLinkAdd(){
  $('#ytLinkBox').after(`
    <div class="input-group" name="ytLinkBox">
      <input type="text" class="form-control datepicker-input" name="yt_link"/>
      <a href="javascript:void(0);" class="btn btn-primary" onclick="removeYtBox(this)"><b>삭제</b></a>
    </div>
    `);
}

function removeYtBox(obj) {
  $(obj).closest('div[name=ytLinkBox]').remove();
}


function noticeDestroy(){
  let conf = confirm('정말 삭제하시겠습니까?\n삭제 후 복구는 불가능합니다.')
  if(!conf)
    return false

  $.ajax(
    {
      type:     "delete",
      url:      "http://210.114.1.125:3000/notice/",
      data:     { notice_id: _value[0].id, },
      dataType: "json",
      success: data => {
        console.log(data)
        // window.location.href = `notice.html`;
      },
      error: error =>  { console.log(error) }
    });
}

$("input[type=file]").on('change',function(){
  let file_names = '';
  let files = $(this)[0].files;
  let text = `${files[0].name} 외 ${files.length - 1} 개`;

  $('#fileName').text(text);
});


</script>
</body>
</html>
